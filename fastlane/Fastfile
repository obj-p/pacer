default_platform(:ios)

platform :ios do
  desc "Sync certificates and profiles using match"
  lane :sync_certs do
    match(type: "adhoc", readonly: is_ci)
  end

  desc "Build ad-hoc IPA"
  lane :build do
    sync_certs

    Dir.chdir("..") { sh("xcodegen") }

    gym(
      scheme: "Pacer",
      project: "Pacer.xcodeproj",
      export_method: "ad-hoc",
      output_directory: "dist",
      output_name: "Pacer",
      clean: true,
      configuration: "Release"
    )
  end

  desc "Build and publish to appserve"
  lane :distribute do
    build
    publish_to_appserve
  end

  private_lane :publish_to_appserve do
    require 'fileutils'

    appserve_dir = ENV['APPSERVE_DIR'] || File.expand_path("~/Projects/appserve")
    version = get_version_number(xcodeproj: "Pacer.xcodeproj", target: "Pacer")
    commit = `git rev-parse --short HEAD`.strip
    dist = File.expand_path("../dist", Dir.pwd)

    icon = File.expand_path("../PacerWatch/Assets.xcassets/AppIcon.appiconset/AppIcon.png", Dir.pwd)
    FileUtils.cp(icon, "#{dist}/icon.png") if File.exist?(icon)

    sh("#{appserve_dir}/publish.sh",
      "--app", "pacer", "--version", version, "--ipa", "#{dist}/Pacer.ipa",
      "--bundle-id", "com.objp.Pacer", "--title", "Pacer",
      "--icon", "#{dist}/icon.png", "--commit", commit,
      "--dsym", "#{dist}/Pacer.app.dSYM.zip",
      "--note", "The watch app will automatically install on your paired Apple Watch.")
  end
end
